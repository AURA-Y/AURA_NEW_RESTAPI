generator client {
  provider   = "prisma-client-js"
  output     = "../generated/prisma"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}

model User {
  userId             String          @id @default(uuid()) @db.Uuid
  email              String          @unique(map: "UQ_4a257d2c9837248d70640b3e36e") @db.VarChar(255)
  userPassword       String          @db.VarChar(255)
  nickName           String          @unique(map: "UQ_949dca0566481700b137756b7b6") @db.VarChar(100)
  googleAccessToken  String?
  googleRefreshToken String?
  googleTokenExpiry  DateTime?       @db.Timestamptz(6)
  createdAt          DateTime        @default(now()) @db.Timestamptz(6)
  updatedAt          DateTime        @default(now()) @updatedAt @db.Timestamptz(6)
  profileImage       String?

  // GitHub 계정 연동
  githubUsername     String?         @db.VarChar(39)
  githubId           Int?
  githubLinkedAt     DateTime?       @db.Timestamptz(6)

  ownedChannels      Channel[]       @relation("ChannelOwner")
  memberships        ChannelMember[]
  joinRequests       JoinRequest[]
  createdRooms       Room[]          @relation("RoomMaster")

  @@index([githubUsername])
}

model Channel {
  channelId            String          @id @default(uuid()) @db.Uuid
  channelName          String          @db.VarChar(100)
  ownerId              String          @db.Uuid
  createdAt            DateTime        @default(now()) @db.Timestamptz(6)
  slackWebhookUrl      String?
  githubAutoCreate     Boolean         @default(false)
  githubIssueLabels    String[]        @default([])
  githubRepoName       String?         @db.VarChar(100)
  githubRepoOwner      String?         @db.VarChar(100)
  githubInstallationId String?
  githubAppId          String?         @db.VarChar(20)
  githubPrivateKey     String?
  githubProjectId      String?         // GitHub Projects v2 node ID
  githubAutoAddToProject Boolean       @default(false)
  owner                User            @relation("ChannelOwner", fields: [ownerId], references: [userId], onDelete: Cascade, onUpdate: NoAction, map: "FK_79ff036dd0e6747303835b0b3b9")
  members              ChannelMember[]
  joinRequests         JoinRequest[]
  rooms                Room[]
  reports              RoomReport[]
  teams                Team[]
}

model ChannelMember {
  userId    String                  @db.Uuid
  channelId String                  @db.Uuid
  teamId    String?                 @db.Uuid
  role      ChannelMember_role_enum @default(MEMBER)
  joinedAt  DateTime                @default(now()) @db.Timestamptz(6)
  channel   Channel                 @relation(fields: [channelId], references: [channelId], onDelete: Cascade, onUpdate: NoAction, map: "FK_10c976f3ff0bbea10b695793452")
  team      Team?                   @relation(fields: [teamId], references: [teamId], onUpdate: NoAction, map: "FK_2d2b775472172d0a404746cb4a5")
  user      User                    @relation(fields: [userId], references: [userId], onDelete: Cascade, onUpdate: NoAction, map: "FK_ef59c13cf97b76aac16a9b629fe")

  @@id([userId, channelId])
}

model Team {
  teamId    String          @id @default(uuid()) @db.Uuid
  teamName  String          @db.VarChar(100)
  createdAt DateTime        @db.Timestamptz(6)
  channelId String          @db.Uuid
  members   ChannelMember[]
  channel   Channel         @relation(fields: [channelId], references: [channelId], onDelete: Cascade, onUpdate: NoAction, map: "FK_89f8ebfc63ee1f17e6fad07726a")
}

model Room {
  roomId               String   @id @db.VarChar(255)
  roomTopic            String   @db.VarChar(255)
  roomPassword         String?  @db.VarChar(50)
  masterId             String   @db.Uuid
  channelId            String   @db.Uuid
  attendees            String[] @default([])
  token                String?
  tags                 String[] @default([])
  participantUserIds   String[] @default([]) @db.Uuid
  roomShareLink        String   @unique(map: "UQ_9afb32bb37027f2d69429d50876") @default(dbgenerated("gen_random_uuid()")) @db.VarChar(255)
  createdAt            DateTime @default(now()) @db.Timestamptz(6)
  uploadFileList       Json     @default("[]")
  githubLabelsOverride String[] @default([])
  githubRepoOverride   String?  @db.VarChar(201)
  referencedFiles      String?
  expectedAttendees    Json?    @default("[]")
  master               User     @relation("RoomMaster", fields: [masterId], references: [userId], onDelete: Cascade, onUpdate: NoAction, map: "FK_56edc8746a89b70d50816f6aaf3")
  channel              Channel  @relation(fields: [channelId], references: [channelId], onDelete: Cascade, onUpdate: NoAction, map: "FK_c3fb69a467978452fb2160f9dfa")
}

model RoomReport {
  reportId           String                     @id @db.VarChar(255)
  topic              String                     @db.VarChar(255)
  attendees          String[]                   @default([])
  shareScope         RoomReport_sharescope_enum @default(CHANNEL)
  specialAuth        String[]                   @default([]) @db.Uuid
  roomId             String                     @unique(map: "UQ_0e72b6c8cd1c2b3bf4f7340b9ea") @db.VarChar(255)
  channelId          String                     @db.Uuid
  tags               String[]                   @default([])
  participantUserIds String[]                   @default([]) @db.Uuid
  createdAt          DateTime                   @default(now()) @db.Timestamptz(6)
  masterId           String?                    @db.Uuid
  endedAt            DateTime?                  @db.Timestamptz(6)
  startedAt          DateTime?                  @db.Timestamptz(6)
  expectedAttendees  Json?                      @default("[]")
  uploadFileList     Json?                      @default("[]")
  referencedFiles    Json?                      @default("[]")
  channel            Channel                    @relation(fields: [channelId], references: [channelId], onDelete: Cascade, onUpdate: NoAction, map: "FK_be4070416b4b332fc4c36a1dae7")
}

model JoinRequest {
  id          String                  @id @default(uuid()) @db.Uuid
  userId      String                  @db.Uuid
  channelId   String                  @db.Uuid
  status      JoinRequest_status_enum @default(PENDING)
  createdAt   DateTime                @default(now()) @db.Timestamptz(6)
  processedAt DateTime?               @db.Timestamptz(6)
  expiresAt   DateTime?               @db.Timestamptz(6)
  user        User                    @relation(fields: [userId], references: [userId], onDelete: Cascade, onUpdate: NoAction, map: "FK_6df814fc490837105048e50429f")
  channel     Channel                 @relation(fields: [channelId], references: [channelId], onDelete: Cascade, onUpdate: NoAction, map: "FK_eade68e793cabddf62d9f8f36c4")
}

enum ChannelMember_role_enum {
  OWNER
  ADMIN
  MEMBER
}

enum JoinRequest_status_enum {
  PENDING
  APPROVED
  REJECTED
}

enum RoomReport_sharescope_enum {
  PUBLIC
  TEAM
  CHANNEL
  PRIVATE
}

// Action Item Issue 관리
model ActionItemIssue {
  id               String                 @id @default(uuid()) @db.Uuid
  reportId         String                 @db.VarChar(255)
  roomId           String                 @db.VarChar(255)

  // 담당자 정보
  assigneeNickName String                 @db.VarChar(100)
  assigneeUserId   String?                @db.Uuid
  githubUsername   String?                @db.VarChar(39)

  // 액션 아이템 내용
  task             String
  dueDate          String?

  // GitHub Issue 정보
  issueNumber      Int?
  issueUrl         String?
  issueState       ActionItemIssueState   @default(PENDING)

  // 타임스탬프
  createdAt        DateTime               @default(now()) @db.Timestamptz(6)
  updatedAt        DateTime               @default(now()) @updatedAt @db.Timestamptz(6)

  @@unique([reportId, task])
  @@index([reportId])
  @@index([roomId])
  @@index([assigneeUserId])
}

enum ActionItemIssueState {
  PENDING
  CREATED
  FAILED
  SKIPPED
}
