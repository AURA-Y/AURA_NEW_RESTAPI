generator client {
  provider   = "prisma-client-js"
  output     = "../generated/prisma"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}

model User {
  userId             String          @id @default(uuid()) @db.Uuid
  email              String          @unique(map: "UQ_4a257d2c9837248d70640b3e36e") @db.VarChar(255)
  userPassword       String          @db.VarChar(255)
  nickName           String          @unique(map: "UQ_949dca0566481700b137756b7b6") @db.VarChar(100)
  profileImage       String?
  googleAccessToken  String?
  googleRefreshToken String?
  googleTokenExpiry  DateTime?       @db.Timestamptz(6)
  createdAt          DateTime        @default(now()) @db.Timestamptz(6)
  updatedAt          DateTime        @default(now()) @updatedAt @db.Timestamptz(6)
  ownedChannels      Channel[]       @relation("ChannelOwner")
  memberships        ChannelMember[]
  joinRequests       JoinRequest[]
  createdRooms       Room[]          @relation("RoomMaster")
}

model Channel {
  channelId       String          @id @default(uuid()) @db.Uuid
  channelName     String          @db.VarChar(100)
  slackWebhookUrl String?         @db.Text // Slack Incoming Webhook URL for sharing meeting reports
  ownerId         String          @db.Uuid
  createdAt       DateTime        @default(now()) @db.Timestamptz(6)

  // GitHub App 연동 설정 (Channel별 독립 GitHub App 지원)
  githubAppId          String?   @db.VarChar(20)   // GitHub App ID (평문, 민감하지 않음)
  githubPrivateKey     String?   @db.Text          // 암호화된 Private Key (PEM 형식)
  githubInstallationId String?   @db.Text          // 암호화된 GitHub App Installation ID
  githubRepoOwner      String?   @db.VarChar(100)  // Organization 또는 User (예: "acme-org")
  githubRepoName       String?   @db.VarChar(100)  // Repository 이름 (예: "team-meetings")
  githubIssueLabels    String[]  @default([])      // Issue 생성 시 기본 라벨 (예: ["meeting-summary"])
  githubAutoCreate     Boolean   @default(false)   // 회의 종료 시 자동 Issue 생성 여부

  owner        User            @relation("ChannelOwner", fields: [ownerId], references: [userId], onDelete: Cascade, onUpdate: NoAction, map: "FK_79ff036dd0e6747303835b0b3b9")
  members      ChannelMember[]
  joinRequests JoinRequest[]
  rooms        Room[]
  reports      RoomReport[]
  teams        Team[]
}

model ChannelMember {
  userId    String                  @db.Uuid
  channelId String                  @db.Uuid
  teamId    String?                 @db.Uuid
  role      ChannelMember_role_enum @default(MEMBER)
  joinedAt  DateTime                @default(now()) @db.Timestamptz(6)
  channel   Channel                 @relation(fields: [channelId], references: [channelId], onDelete: Cascade, onUpdate: NoAction, map: "FK_10c976f3ff0bbea10b695793452")
  team      Team?                   @relation(fields: [teamId], references: [teamId], onUpdate: NoAction, map: "FK_2d2b775472172d0a404746cb4a5")
  user      User                    @relation(fields: [userId], references: [userId], onDelete: Cascade, onUpdate: NoAction, map: "FK_ef59c13cf97b76aac16a9b629fe")

  @@id([userId, channelId])
}

model Team {
  teamId    String          @id @default(uuid()) @db.Uuid
  teamName  String          @db.VarChar(100)
  createdAt DateTime        @db.Timestamptz(6)
  channelId String          @db.Uuid
  members   ChannelMember[]
  channel   Channel         @relation(fields: [channelId], references: [channelId], onDelete: Cascade, onUpdate: NoAction, map: "FK_89f8ebfc63ee1f17e6fad07726a")
}

model Room {
  roomId             String   @id @db.VarChar(255)
  roomTopic          String   @db.VarChar(255)
  roomPassword       String?  @db.VarChar(50)
  masterId           String   @db.Uuid
  channelId          String   @db.Uuid
  attendees          String[] @default([])
  token              String?
  tags               String[] @default([])
  participantUserIds String[] @default([]) @db.Uuid
  roomShareLink      String   @unique(map: "UQ_9afb32bb37027f2d69429d50876") @default(dbgenerated("gen_random_uuid()")) @db.VarChar(255)
  createdAt          DateTime @default(now()) @db.Timestamptz(6)
  uploadFileList     Json     @default("[]")
  referencedFiles    String?

  // GitHub 오버라이드 설정 (이 방만 다른 리포지토리 사용)
  githubRepoOverride   String?  @db.VarChar(201)  // "owner/repo" 형식 (예: "acme-org/backend")
  githubLabelsOverride String[] @default([])      // 오버라이드 라벨 (빈 배열이면 Channel 설정 사용)

  master             User     @relation("RoomMaster", fields: [masterId], references: [userId], onDelete: Cascade, onUpdate: NoAction, map: "FK_56edc8746a89b70d50816f6aaf3")
  channel            Channel  @relation(fields: [channelId], references: [channelId], onDelete: Cascade, onUpdate: NoAction, map: "FK_c3fb69a467978452fb2160f9dfa")
}

model RoomReport {
  reportId            String                     @id @db.VarChar(255)
  topic               String                     @db.VarChar(255)
  attendees           String[]                   @default([])
  shareScope          RoomReport_sharescope_enum @default(CHANNEL)
  specialAuth         String[]                   @default([]) @db.Uuid
  roomId              String                     @unique(map: "UQ_0e72b6c8cd1c2b3bf4f7340b9ea") @db.VarChar(255)
  channelId           String                     @db.Uuid
  tags                String[]                   @default([])
  participantUserIds  String[]                   @default([]) @db.Uuid
  createdAt           DateTime                   @default(now()) @db.Timestamptz(6)
  startedAt           DateTime?                  @db.Timestamptz(6)
  endedAt             DateTime?                  @db.Timestamptz(6)
  masterId            String?                    @db.Uuid
  channel             Channel                    @relation(fields: [channelId], references: [channelId], onDelete: Cascade, onUpdate: NoAction, map: "FK_be4070416b4b332fc4c36a1dae7")
}

model JoinRequest {
  id          String                  @id @default(uuid()) @db.Uuid
  userId      String                  @db.Uuid
  channelId   String                  @db.Uuid
  status      JoinRequest_status_enum @default(PENDING)
  createdAt   DateTime                @default(now()) @db.Timestamptz(6)
  processedAt DateTime?               @db.Timestamptz(6)
  expiresAt   DateTime?               @db.Timestamptz(6)
  user        User                    @relation(fields: [userId], references: [userId], onDelete: Cascade, onUpdate: NoAction, map: "FK_6df814fc490837105048e50429f")
  channel     Channel                 @relation(fields: [channelId], references: [channelId], onDelete: Cascade, onUpdate: NoAction, map: "FK_eade68e793cabddf62d9f8f36c4")
}

enum ChannelMember_role_enum {
  OWNER
  ADMIN
  MEMBER
}

enum JoinRequest_status_enum {
  PENDING
  APPROVED
  REJECTED
}

enum RoomReport_sharescope_enum {
  PUBLIC
  TEAM
  CHANNEL
  PRIVATE
}
