// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// --------------------------------------
// 1. Enums (열거형)
// --------------------------------------

enum ChannelRole {
  OWNER // 채널 소유자 (회사 대표)
  ADMIN // 관리자
  MEMBER // 일반 멤버
}

enum ReportScope {
  PUBLIC // 전체 공개
  TEAM // 특정 팀 공개
  CHANNEL // 채널 전체 공개
  PRIVATE // 참여자만 공개
}

enum JoinRequestStatus {
  PENDING  // 대기중
  APPROVED // 승인됨
  REJECTED // 거절됨
}

// --------------------------------------
// 2. Models
// --------------------------------------

model User {
  userId       String   @id @default(uuid()) @db.Uuid
  email        String   @unique @db.VarChar(255)
  userPassword String   @db.VarChar(255)
  nickName     String   @unique @db.VarChar(100)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Google OAuth 토큰 (캘린더 연동용)
  googleAccessToken  String?   @db.Text
  googleRefreshToken String?   @db.Text
  googleTokenExpiry  DateTime? @db.Timestamptz

  // 관계 설정
  ownedChannels Channel[]       @relation("ChannelOwner") // 내가 만든 채널들
  memberships   ChannelMember[] // 내가 소속된 채널 및 역할 정보
  createdRooms  Room[]          @relation("RoomMaster") // 내가 방장인 회의방들
  joinRequests  JoinRequest[]   // 내가 보낸 가입 요청들
}

model Channel {
  channelId   String   @id @default(uuid()) @db.Uuid
  channelName String   @db.VarChar(100)
  createdAt   DateTime @default(now())

  // 소유자 관계
  ownerId String @db.Uuid
  owner   User   @relation("ChannelOwner", fields: [ownerId], references: [userId])

  // 채널 내 리소스
  members      ChannelMember[]
  teams        Team[]
  rooms        Room[]
  reports      RoomReport[]
  joinRequests JoinRequest[] // 이 채널에 대한 가입 요청들
}

model ChannelMember {
  userId    String      @db.Uuid
  channelId String      @db.Uuid
  teamId    String?     @db.Uuid // 소속된 팀 (없을 수 있음)
  role      ChannelRole @default(MEMBER)
  joinedAt  DateTime    @default(now())

  user    User    @relation(fields: [userId], references: [userId], onDelete: Cascade)
  channel Channel @relation(fields: [channelId], references: [channelId], onDelete: Cascade)
  team    Team?   @relation(fields: [teamId], references: [teamId], onDelete: SetNull)

  @@id([userId, channelId]) // 복합키 설정 (userId, channelId 순서로 변경)
}

model Team {
  teamId    String   @id @default(uuid()) @db.Uuid
  teamName  String   @db.VarChar(100)
  createdAt DateTime @default(now())

  channelId String  @db.Uuid
  channel   Channel @relation(fields: [channelId], references: [channelId], onDelete: Cascade)

  members ChannelMember[] // 팀에 속한 멤버들
}

model Room {
  roomId          String   @id @db.VarChar(255) // 회의방 고유 ID 백엔드에서 생성 room- 형식
  roomTopic       String   @db.VarChar(255)     // 생성자가 작성한 회의 주제
  roomDescription String?  @db.Text             // 생성자가 작성한 회의 목표
  roomPassword    String?  @db.VarChar(50)      // 생성자가 설정한 회의방 비번
  roomShareLink   String   @unique              // 회의방 공유 링크
  createdAt       DateTime @default(now())      // 회의방 생성 일시

  // 방장 정보
  masterId String @db.Uuid
  master   User   @relation("RoomMaster", fields: [masterId], references: [userId])

  // 소속 정보
  channelId String  @db.Uuid
  channel   Channel @relation(fields: [channelId], references: [channelId])

  // 접근 권한 (유저 기반) - 빈 배열이면 전체 공개
  participantUserIds String[] @default([]) @db.Uuid

  // 회의 데이터
  attendees String[] @default([])
  token     String?  @db.Text // 미디어 서버 접속용 토큰
  tags      String[] @default([]) // 회의 태그 (최대 10개)

  // 파일 (JSON 형태로 저장)
  // [{fileId, fileName, fileUrl, fileSize, createdAt}, ...]
  uploadFileList Json @default("[]")
}

model RoomReport {
  reportId    String   @id @db.VarChar(255) // roomId와 동일한 값
  topic       String   @db.VarChar(255)
  description String?  @db.Text
  attendees   String[] @default([])
  tags        String[] @default([]) // 회의 태그 (Room에서 복사)
  createdAt   DateTime @default(now())

  // 권한 범위 설정
  shareScope  ReportScope @default(CHANNEL)
  specialAuth String[]    @default([]) @db.Uuid // 특별 열람 권한을 가진 userId 배열

  // roomId는 FK 없이 단순 문자열로 저장 (Room 삭제 시 Report 유지)
  roomId String @unique @db.VarChar(255)

  // Channel 관계만 유지 (Team 관계 제거)
  channelId String  @db.Uuid
  channel   Channel @relation(fields: [channelId], references: [channelId])

  // 접근 권한 (유저 기반) - 빈 배열이면 전체 공개
  participantUserIds String[] @default([]) @db.Uuid
}

model JoinRequest {
  id          String            @id @default(uuid()) @db.Uuid
  userId      String            @db.Uuid
  channelId   String            @db.Uuid
  status      JoinRequestStatus @default(PENDING)
  createdAt   DateTime          @default(now())
  processedAt DateTime?
  expiresAt   DateTime?         // 만료 시간 (처리 후 24시간)

  user    User    @relation(fields: [userId], references: [userId])
  channel Channel @relation(fields: [channelId], references: [channelId])

  @@unique([userId, channelId]) // 중복 요청 방지
}
